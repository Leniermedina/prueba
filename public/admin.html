<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Dual Cell Corp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/app.js"></script>
  <style>
    /* ... (estilos sin cambios) ... */
  </style>
</head>
<body>
  <main style="max-width:1000px;margin:100px auto;padding:0 15px;color:#d7ffe9">
    <h1 style="color:#00ff9d">Panel de administración</h1>
    <section style="margin:20px 0;border:1px solid #00ff9d;border-radius:12px;padding:15px;background:#0f1c2f">
      <form id="admin-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label>Nombre</label><input name="name" required style="width:100%"></div>
        <div><label>Categoría</label>
          <select name="category" style="width:100%">
            <option value="moviles">Móviles</option>
            <option value="covers">Covers</option>
            <option value="accesorios">Accesorios</option>
          </select>
        </div>
        <div><label>Precio</label><input name="price" type="number" step="0.01" required style="width:100%"></div>
        <div><label>Imagen (URL)</label><input name="imageUrl" style="width:100%"></div>
        <div><label>o Subir imagen</label><input name="file" type="file" accept="image/*"></div>
        <div style="grid-column:1/-1"><button class="btn-nav">Guardar</button></div>
      </form>
    </section>
    <section style="margin:20px 0;border:1px solid #00ff9d;border-radius:12px;padding:15px;background:#0f1c2f">
      <h2 style="color:#00ff9d">Productos</h2>
      <ul id="admin-products" style="list-style:none;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
    </section>
  </main>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('AUTH_TOKEN');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Verificar token primero
      try {
        const meResponse = await fetch('/api/me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!meResponse.ok) {
          window.location.href = '/login.html';
          return;
        }
        
        const me = await meResponse.json();
        if (!me.isAdmin) {
          alert('No tienes permisos de administrador');
          window.location.href = '/index.html';
          return;
        }
      } catch (e) {
        console.error('Admin verification error:', e);
        alert('Error de verificación');
        window.location.href = '/login.html';
        return;
      }
      
      const form = document.getElementById('admin-form');
      const productsList = document.getElementById('admin-products');
      
      async function loadProducts() {
        const response = await fetch('/api/products', {
          headers: { 
            Authorization: `Bearer ${token}`,
            'Cache-Control': 'no-store'
          }
        });
        
        if (!response.ok) {
          if (response.status === 403) {
            alert('No tienes permisos de administrador');
            window.location.href = '/index.html';
          }
          return;
        }
        
        const products = await response.json();
        productsList.innerHTML = products.map(product => `
          <li data-id="${product.id}">
            <img src="${product.image}" style="width:48px;height:48px;object-fit:cover;border:1px solid #00ff9d;border-radius:6px;margin-right:8px">
            <strong>${product.name}</strong> — $${Number(product.price||0).toFixed(2)}
            <button data-act="edit">Editar</button>
            <button data-act="del">Eliminar</button>
          </li>
        `).join('');
      }
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        
        // Subir imagen si existe
        let imageUrl = formData.get('imageUrl');
        const file = formData.get('file');
        
        if (file.size > 0) {
          const uploadData = new FormData();
          uploadData.append('file', file);
          
          const uploadResponse = await fetch('/api/upload', {
            method: 'POST',
            body: uploadData,
            headers: { Authorization: `Bearer ${token}` }
          });
          
          if (!uploadResponse.ok) {
            alert('Error subiendo imagen');
            return;
          }
          
          const uploadResult = await uploadResponse.json();
          imageUrl = uploadResult.url;
        }
        
        const productData = {
          name: formData.get('name'),
          category: formData.get('category'),
          price: formData.get('price'),
          image: imageUrl
        };
        
        const method = 'POST';
        const response = await fetch('/api/products', {
          method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(productData)
        });
        
        if (response.ok) {
          form.reset();
          loadProducts();
          alert('Producto guardado');
        } else {
          alert('Error guardando producto');
        }
      });
      
      productsList.addEventListener('click', async (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        
        const li = e.target.closest('li');
        const id = li.dataset.id;
        const action = e.target.dataset.act;
        
        if (action === 'del') {
          if (!confirm('¿Eliminar producto?')) return;
          
          const response = await fetch(`/api/products?id=${id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` }
          });
          
          if (response.ok) {
            loadProducts();
          } else {
            alert('Error eliminando producto');
          }
        }
      });
      
      await loadProducts();
    });
  </script>
</body>
</html>