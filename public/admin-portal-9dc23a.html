<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Productos (oculto)</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b1320; color:#d7ffe9; margin:0; padding:20px }
    h1 { margin:0 0 16px }
    .wrap { max-width:980px; margin:0 auto }
    .card { background:#0f1c2f; padding:16px; border-radius:12px; margin:12px 0; border:1px solid #163350 }
    label { display:block; margin:8px 0 4px }
    input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #2a4f73; background:#0b1626; color:#d7ffe9 }
    button { cursor:pointer; padding:10px 14px; border-radius:10px; border:0; background:#00ff9d; color:#063220; font-weight:700 }
    button.danger { background:#ff5c5c; color:#2a0f0f }
    table { width:100%; border-collapse: collapse; margin-top: 12px }
    th, td { border-bottom:1px solid #163350; padding:8px; text-align:left; vertical-align:top; word-break: break-word }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .muted { opacity:.75; font-size:.9rem }
    .grid { display:grid; gap:12px; grid-template-columns:1fr 1fr }
    @media (max-width: 720px){ .grid{ grid-template-columns:1fr } }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Panel Admin (oculto)</h1>
  <p class="muted">Esta página no está enlazada y tiene <code>noindex</code>. Guarda la URL.</p>

  <div class="card">
    <div class="row">
      <button id="btnSetToken">Cambiar token admin</button>
      <span id="tokenState" class="muted"></span>
      <button id="btnReload">Recargar lista</button>
      <a href="/productos.html"><button>Ir a Productos</button></a>
    </div>
  </div>

  <div class="card">
    <h2>Crear / Editar producto</h2>
    <div class="grid">
      <div>
        <label>Nombre</label>
        <input id="fNombre" placeholder="Ej. Funda antigolpes">
      </div>
      <div>
        <label>Categoría</label>
        <select id="fCategoria">
          <option value="moviles">moviles</option>
          <option value="covers">covers</option>
          <option value="accesorios">accesorios</option>
        </select>
      </div>
      <div>
        <label>Precio (USD)</label>
        <input id="fPrecio" type="number" step="0.01" min="0" placeholder="9.99">
      </div>
      <div>
        <label>Imagen (URL)</label>
        <input id="fImagen" placeholder="https://...">
        <span class="muted">Por ahora pegamos URL de imagen. (Si luego quieres subir archivos, agregamos /api/upload con Vercel Blob).</span>
      </div>
      <input id="fId" type="hidden">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnGuardar">Guardar</button>
      <button id="btnLimpiar" class="danger">Limpiar</button>
      <span class="muted" id="formMsg"></span>
    </div>
  </div>

  <div class="card">
    <h2>Productos</h2>
    <table id="tabla">
      <thead>
        <tr><th>Nombre</th><th>Categoría</th><th>Precio</th><th>Imagen</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API = '/api/products'; // ← mismo dominio; evita CORS y 404
// token: se guarda SOLO en esta pestaña
function getToken(){ return sessionStorage.getItem('ADMIN_TOKEN') || ''; }
function setTokenFlow(){
  const t = prompt('Pega tu ADMIN_TOKEN (se guardará SOLO en esta pestaña):','');
  if(t) sessionStorage.setItem('ADMIN_TOKEN', t);
  paintTokenState();
}
function paintTokenState(){
  document.getElementById('tokenState').textContent =
    getToken() ? 'Token cargado en memoria (sessionStorage).' : 'Sin token. No podrás crear/editar/borrar.';
}
document.getElementById('btnSetToken').onclick = setTokenFlow;

const $ = sel => document.querySelector(sel);
function fmt(n){ return Number(n||0).toFixed(2); }
function clearForm(){
  $('#fId').value=''; $('#fNombre').value=''; $('#fCategoria').value='moviles';
  $('#fPrecio').value=''; $('#fImagen').value=''; $('#formMsg').textContent='';
}
$('#btnLimpiar').onclick = clearForm;

// Carga general (GET público)
async function loadList(){
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
  try{
    const res = await fetch(API, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status+': '+await res.text());
    const data = await res.json();
    const items = Array.isArray(data) ? data : (data.items || []);
    if(!items.length){ tbody.innerHTML = '<tr><td colspan="5">Sin productos</td></tr>'; return; }

    // pinta tabla
    tbody.innerHTML = items.map(p => `
      <tr data-id="${p.id}">
        <td>${p.nombre || p.name || ''}</td>
        <td>${p.categoria || p.category || ''}</td>
        <td>$${fmt(p.precio ?? p.price)}</td>
        <td>${p.imagen || p.image || ''}</td>
        <td>
          <button data-act="edit">Editar</button>
          <button data-act="del" class="danger">Eliminar</button>
        </td>
      </tr>
    `).join('');

  }catch(e){
    tbody.innerHTML = '<tr><td colspan="5">Error al cargar: '+e.message+'</td></tr>';
  }
}

document.querySelector('#tabla').addEventListener('click', async e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = btn.closest('tr'); const id = tr?.getAttribute('data-id');
  const act = btn.getAttribute('data-act'); if(!id) return;

  if(act==='edit'){
    // rellenar form con la fila (no existe GET /products/:id)
    $('#fId').value = id;
    $('#fNombre').value = tr.children[0].textContent.trim();
    $('#fCategoria').value = tr.children[1].textContent.trim();
    $('#fPrecio').value = tr.children[2].textContent.replace('$','').trim();
    $('#fImagen').value = tr.children[3].textContent.trim();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  if(act==='del'){
    if(!confirm('¿Eliminar este producto?')) return;
    const token = getToken();
    if(!token) return alert('Falta ADMIN_TOKEN (usa "Cambiar token admin").');

    const res = await fetch(API + '?id=' + encodeURIComponent(id), {
      method:'DELETE',
      headers:{ Authorization:'Bearer '+token }
    });
    if(res.status===204){ await loadList(); }
    else { alert('Error al eliminar: ' + await res.text()); }
  }
});

document.getElementById('btnGuardar').onclick = async ()=>{
  const id = $('#fId').value.trim();
  const nombre = $('#fNombre').value.trim();
  const categoria = $('#fCategoria').value;
  const precio = parseFloat($('#fPrecio').value);
  const imagen = $('#fImagen').value.trim();
  if(!nombre || !categoria || isNaN(precio)){ $('#formMsg').textContent='Completa nombre, categoría y precio.'; return; }

  const token = getToken();
  if(!token) return alert('Falta ADMIN_TOKEN (usa "Cambiar token admin").');

  const payload = { id, nombre, categoria, precio, image: imagen, imagen, price: precio, category: categoria };
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(API, {
    method,
    headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token },
    body: JSON.stringify(payload)
  });
  if(!res.ok){ return alert('Error al guardar: ' + await res.text()); }

  clearForm(); await loadList(); alert(id ? 'Producto actualizado' : 'Producto creado');
};

document.getElementById('btnReload').onclick = loadList;

// init
document.addEventListener('DOMContentLoaded', ()=>{ paintTokenState(); clearForm(); loadList(); });
</script>
</body>
</html>
